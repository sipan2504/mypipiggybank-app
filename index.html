<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Piggy Bank for Pi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Genel stil ayarlarÄ± */
        body { font-family: 'Inter', sans-serif; text-align: center; padding-top: 50px; background-color: #f0f2f5; color: #333; margin: 0; }
        .container { max-width: 600px; margin: auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { background-color: #4a90e2; color: white; padding: 20px; text-align: center; }
        .card { background-color: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .balance { font-size: 2.5em; font-weight: bold; margin: 10px 0; color: #4a90e2; }
        .button-group { display: flex; justify-content: space-around; margin-top: 20px; }
        .button-group button { padding: 15px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; color: white; width: 45%; }
        .lock-button { background-color: #f5a623; }
        .history-button { background-color: #50e3c2; }
        #app-page { display: none; } /* Uygulama sayfasÄ± baÅŸlangÄ±Ã§ta gizli */
        .message-box {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        #pi-browser-warning {
            background-color: #ffcccc;
            color: #cc0000;
            padding: 20px;
            font-weight: bold;
            display: none;
        }
        #loading-indicator {
            margin-top: 10px;
            font-style: italic;
            color: #555;
            display: none;
        }
        .plan-input, .prediction-input { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; resize: vertical; }
        .gemini-button { background-color: #7252f3; width: 100%; padding: 15px; font-size: 16px; border-radius: 5px; color: white; cursor: pointer; }
        .plan-output, .prediction-output { margin-top: 20px; text-align: left; background-color: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid white; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tts-button { background-color: #4299e1; padding: 10px; font-size: 14px; border-radius: 5px; color: white; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- GÄ°RÄ°Åž SAYFASI -->
    <div id="login-page" class="container">
        <h1>Global Piggy Bank for Pi'ye HoÅŸ Geldiniz!</h1>
        <p>Devam etmek iÃ§in Pi Network hesabÄ±nÄ±zÄ± doÄŸrulamanÄ±z gerekiyor.</p>
        <div id="pi-browser-warning">
            Bu uygulama yalnÄ±zca **Pi Browser** iÃ§inde Ã§alÄ±ÅŸÄ±r.
            LÃ¼tfen uygulamayÄ± Pi Browser'da aÃ§Ä±n.
        </div>
        <button id="auth-button" disabled>Pi ile GiriÅŸ Yap</button>
        <div id="loading-indicator">YÃ¼kleniyor...</div>
        <div id="message-box" class="message-box"></div>
    </div>

    <!-- UYGULAMA SAYFASI -->
    <div id="app-page">
        <div class="header">
            <h1>Global Piggy Bank for Pi</h1>
            <p id="welcome-message">HoÅŸ geldiniz, [KullanÄ±cÄ± AdÄ±]!</p>
        </div>
        <div class="container">
            <div class="card">
                <h3>Pi Bakiyeniz</h3>
                <div class="balance">125.76 Pi</div>
                <p>GÃ¼ncel Pi bakiyenizi buradan takip edebilirsiniz.</p>
            </div>
            <div class="card">
                <h3>Pi'lerinizi Kilitleyin</h3>
                <p>Pi'lerinizi belirli bir sÃ¼re kilitleyerek Ã¶dÃ¼l kazanabilirsiniz.</p>
                <div class="button-group">
                    <button class="lock-button">Pi Kilitle</button>
                    <button class="history-button">Kilitleme GeÃ§miÅŸi</button>
                </div>
            </div>
            <!-- Gemini API destekli birikim planÄ± Ã¶zelliÄŸi -->
            <div class="card">
                <h3>Hedeflerinize UlaÅŸÄ±n âœ¨</h3>
                <p>Birikim hedefinizi girin, Gemini size Ã¶zel bir plan oluÅŸtursun!</p>
                <textarea id="plan-goal-input" class="plan-input" placeholder="Ã–rnek: 100 Pi biriktirmek"></textarea>
                <button id="generate-plan-button" class="gemini-button">Plan OluÅŸtur âœ¨</button>
                <div id="plan-output" class="plan-output hidden"></div>
                <button id="read-plan-button" class="tts-button hidden">PlanÄ± Seslendir ðŸ”Š</button>
            </div>
            <!-- Gemini API destekli Pi deÄŸeri tahmin Ã¶zelliÄŸi -->
            <div class="card">
                <h3>Pi DeÄŸeri Tahmin AracÄ± âœ¨</h3>
                <p>Pi'nin geleceÄŸi veya olasÄ± deÄŸeri hakkÄ±nda bir soru sorun. (Bu bir finansal tavsiye deÄŸildir.)</p>
                <textarea id="prediction-question-input" class="prediction-input" placeholder="Ã–rnek: Pi'nin deÄŸeri 2025'in sonuna kadar ne kadar olabilir?"></textarea>
                <button id="get-prediction-button" class="gemini-button">Tahmin Al âœ¨</button>
                <div id="prediction-output" class="prediction-output hidden"></div>
            </div>
        </div>
    </div>

    <!-- Pi SDK yÃ¼kleme script'i -->
    <!-- Bu script'in sadece Pi Browser'da yÃ¼kleneceÄŸini unutmayÄ±n -->
    <script id="pi-sdk-script" src="https://sdk.minepi.com/v2/pi-sdk.js" async></script>

    <!-- Uygulama mantÄ±ÄŸÄ± -->
    <script>
        // Mesaj kutusunu gÃ¶stermek iÃ§in yardÄ±mcÄ± fonksiyon
        function showMessage(message, isError = false, targetId = 'message-box') {
            const msgBox = document.getElementById(targetId);
            msgBox.innerText = message;
            msgBox.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
            msgBox.style.color = isError ? '#721c24' : '#155724';
            msgBox.style.display = 'block';
        }

        // YÃ¼kleme durumunu yÃ¶netmek iÃ§in yardÄ±mcÄ± fonksiyon
        function toggleLoading(isLoading) {
            const button = document.getElementById('auth-button');
            const loader = document.getElementById('loading-indicator');
            button.disabled = isLoading;
            loader.style.display = isLoading ? 'block' : 'none';
        }

        // Gemini API iÃ§in yÃ¼kleme durumunu yÃ¶netme (Birikim planÄ±)
        function togglePlanLoading(isLoading) {
            const button = document.getElementById('generate-plan-button');
            const outputDiv = document.getElementById('plan-output');
            const readButton = document.getElementById('read-plan-button');
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<div class="spinner"></div>';
                outputDiv.innerText = 'Plan oluÅŸturuluyor...';
                outputDiv.style.display = 'block';
                readButton.classList.add('hidden');
            } else {
                button.disabled = false;
                button.innerHTML = 'Plan OluÅŸtur âœ¨';
            }
        }
        
        // Gemini API iÃ§in yÃ¼kleme durumunu yÃ¶netme (Pi deÄŸeri tahmini)
        function togglePredictionLoading(isLoading) {
            const button = document.getElementById('get-prediction-button');
            const outputDiv = document.getElementById('prediction-output');
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<div class="spinner"></div>';
                outputDiv.innerText = 'Tahmin alÄ±nÄ±yor...';
                outputDiv.style.display = 'block';
            } else {
                button.disabled = false;
                button.innerHTML = 'Tahmin Al âœ¨';
            }
        }

        // Pi ile giriÅŸ yapma fonksiyonu
        function signInWithPi() {
            toggleLoading(true);
            try {
                // Pi nesnesinin varlÄ±ÄŸÄ±nÄ± kontrol et
                if (typeof Pi !== 'undefined') {
                    Pi.authenticate({
                        scopes: ['username'],
                        onIncomplete: function(data) {
                            toggleLoading(false);
                            console.log("DoÄŸrulama tamamlanmadÄ±:", data);
                            showMessage("DoÄŸrulama iÅŸlemi tamamlanmadÄ±. LÃ¼tfen tekrar deneyin.", true);
                        },
                        onComplete: function(data) {
                            toggleLoading(false);
                            console.log("DoÄŸrulama baÅŸarÄ±lÄ±:", data);
                            showMessage("GiriÅŸ baÅŸarÄ±lÄ±! Uygulama sayfasÄ± yÃ¼kleniyor...");
                            
                            document.getElementById('login-page').style.display = 'none';
                            document.getElementById('app-page').style.display = 'block';
                            
                            const username = data.user.username || "[KullanÄ±cÄ± AdÄ±]";
                            document.getElementById('welcome-message').innerText = `HoÅŸ geldiniz, ${username}!`;
                        },
                        onCancel: function() {
                            toggleLoading(false);
                            console.log("DoÄŸrulama iÅŸlemi iptal edildi.");
                            showMessage("DoÄŸrulama iÅŸlemi iptal edildi.", true);
                        }
                    });
                } else {
                    toggleLoading(false);
                    // Bu senaryo normalde `onload` event'i sayesinde gerÃ§ekleÅŸmeyecek
                    // ancak yine de bir gÃ¼venlik Ã¶nlemi olarak kalmalÄ±dÄ±r.
                    showMessage("Pi SDK bulunamadÄ±. LÃ¼tfen bu uygulamayÄ± Pi Browser'da aÃ§Ä±n.", true);
                }
            } catch (error) {
                toggleLoading(false);
                console.error("Kimlik doÄŸrulama sÄ±rasÄ±nda bir hata oluÅŸtu:", error);
                showMessage(`Beklenmedik bir hata oluÅŸtu: ${error.message}`, true);
            }
        }
        
        // Gemini API kullanarak birikim planÄ± oluÅŸturan fonksiyon
        async function generateSavingsPlan() {
            const goalInput = document.getElementById('plan-goal-input').value;
            const outputDiv = document.getElementById('plan-output');

            if (goalInput.trim() === "") {
                outputDiv.innerText = "LÃ¼tfen bir birikim hedefi girin.";
                outputDiv.style.display = 'block';
                return;
            }

            togglePlanLoading(true);
            
            try {
                const prompt = `Birikim hedefim: ${goalInput}. Bir Pi Network finansal danÄ±ÅŸmanÄ± gibi davranarak bu hedefe ulaÅŸmam iÃ§in bana haftalÄ±k, aylÄ±k ve uzun vadeli adÄ±mlarÄ± iÃ§eren detaylÄ± bir plan oluÅŸtur. Plan Pi cÃ¼zdanÄ±mdaki Pi birikimine odaklanmalÄ±dÄ±r. Maddeler halinde yanÄ±t ver ve anlaÅŸÄ±lÄ±r bir dil kullan.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    outputDiv.innerText = text;
                    document.getElementById('read-plan-button').classList.remove('hidden');
                } else {
                    outputDiv.innerText = "Bir plan oluÅŸturulurken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.";
                }

            } catch (error) {
                console.error("Gemini API Ã§aÄŸrÄ±sÄ± sÄ±rasÄ±nda bir hata oluÅŸtu:", error);
                outputDiv.innerText = `Beklenmedik bir hata oluÅŸtu: ${error.message}`;
            } finally {
                togglePlanLoading(false);
            }
        }

        // Gemini API kullanarak Pi deÄŸeri tahmini yapan fonksiyon
        async function getPiValuePrediction() {
            const questionInput = document.getElementById('prediction-question-input').value;
            const outputDiv = document.getElementById('prediction-output');

            if (questionInput.trim() === "") {
                outputDiv.innerText = "LÃ¼tfen bir soru girin.";
                outputDiv.style.display = 'block';
                return;
            }

            togglePredictionLoading(true);

            try {
                const prompt = `Bu bir finansal tavsiye deÄŸildir. Sadece tahmine dayalÄ± bir analizdir. Soru: ${questionInput}. Bu soruya bir kripto para analisti gibi davranarak, Pi Network'Ã¼n gÃ¼ncel durumu ve piyasa trendleri hakkÄ±nda bilgi vererek spekÃ¼latif bir tahmin yap. CevabÄ±nÄ± bir paragraf halinde ve net bir ÅŸekilde belirt.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    outputDiv.innerText = text;
                } else {
                    outputDiv.innerText = "Bir tahmin oluÅŸturulurken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.";
                }

            } catch (error) {
                console.error("Gemini API Ã§aÄŸrÄ±sÄ± sÄ±rasÄ±nda bir hata oluÅŸtu:", error);
                outputDiv.innerText = `Beklenmedik bir hata oluÅŸtu: ${error.message}`;
            } finally {
                togglePredictionLoading(false);
            }
        }

        // PCM verisini WAV formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼ren yardÄ±mcÄ± fonksiyon
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            // WAV baÅŸlÄ±ÄŸÄ±
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            
            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // Linear PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // Byte Rate
            view.setUint16(32, 2, true); // Block Align
            view.setUint16(34, 16, true); // Bits per sample
            
            // Data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);

            // PCM verisi
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Gemini TTS API kullanarak planÄ± seslendiren fonksiyon
        async function readPlanAloud() {
            const planText = document.getElementById('plan-output').innerText;
            const audio = new Audio();
            const readButton = document.getElementById('read-plan-button');
            
            if (!planText || planText.length < 50) {
                showMessage("Seslendirilecek yeterli metin yok.", true);
                return;
            }

            readButton.disabled = true;
            readButton.innerText = "Seslendiriliyor...";
            
            try {
                const prompt = planText;
                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                
                const apiKey = ""; // Canvas'dan otomatik olarak saÄŸlanacak
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audio.src = audioUrl;
                    audio.play();
                } else {
                    showMessage("Ses oluÅŸturulurken bir hata oluÅŸtu.", true);
                }

            } catch (error) {
                console.error("TTS API Ã§aÄŸrÄ±sÄ± sÄ±rasÄ±nda bir hata oluÅŸtu:", error);
                showMessage(`Seslendirme sÄ±rasÄ±nda beklenmedik bir hata oluÅŸtu: ${error.message}`, true);
            } finally {
                readButton.disabled = false;
                readButton.innerText = "PlanÄ± Seslendir ðŸ”Š";
            }
        }

        // DOM yÃ¼klendikten sonra tÃ¼m script'leri baÅŸlat
        document.addEventListener('DOMContentLoaded', () => {
            const authButton = document.getElementById('auth-button');
            const generatePlanButton = document.getElementById('generate-plan-button');
            const getPredictionButton = document.getElementById('get-prediction-button');
            const readPlanButton = document.getElementById('read-plan-button');
            
            // Pi SDK'sÄ±nÄ±n yÃ¼klÃ¼ olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            if (typeof Pi !== 'undefined') {
                document.getElementById('pi-browser-warning').style.display = 'none';
                try {
                    Pi.init({
                        version: "2.0",
                        app_id: "global-piggybank-for-pi",
                        onReady: function() {
                            console.log("Pi SDK hazÄ±r.");
                            authButton.disabled = false;
                            authButton.addEventListener('click', signInWithPi);
                        }
                    });
                } catch (error) {
                    console.error("Pi SDK baÅŸlatÄ±lÄ±rken bir hata oluÅŸtu:", error);
                    showMessage(`Pi SDK baÅŸlatma hatasÄ±: ${error.message}`, true, 'message-box');
                }
            } else {
                // Pi SDK yoksa uyarÄ±yÄ± gÃ¶ster
                document.getElementById('pi-browser-warning').style.display = 'block';
                authButton.disabled = true;
                authButton.innerText = "Pi Browser'da AÃ§Ä±n";
                authButton.addEventListener('click', () => {
                    alert("Bu uygulama yalnÄ±zca Pi Browser iÃ§inde Ã§alÄ±ÅŸÄ±r.");
                });
            }
            
            // DiÄŸer Ã¶zelliklerin olay dinleyicilerini ekle (bunlar Pi'ye baÄŸÄ±mlÄ± deÄŸil)
            generatePlanButton.addEventListener('click', generateSavingsPlan);
            getPredictionButton.addEventListener('click', getPiValuePrediction);
            readPlanButton.addEventListener('click', readPlanAloud);
        });
    </script>
</body>
</html>
